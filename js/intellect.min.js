!function(t){function i(t){switch(t.data.command){case"Train":r=new o(t.data.options),r.Weights=t.data.weights,r.Biases=t.data.biases;var i=r.Train(t.data.data,t.data.trainingOptions);self.postMessage({command:"Trained",result:i,weights:r.Weights,biases:r.Biases}),self.close();break;case"Genetic":r=new o(t.data.options);var i=r.Train(t.data.data,t.data.trainingOptions,function(t){self.postMessage({command:"Trained",result:t,weights:r.Weights,biases:r.Biases}),self.close()});break;case"Stop":self.postMessage({command:"Trained",result:i,weights:r.Weights,biases:r.Biases}),self.close();break;default:console.log("Worker received",t.data)}}function e(t){switch(t.data.command){case"Trained":this.prototype._this.Weights=t.data.weights,this.prototype._this.Biases=t.data.biases,this.prototype._this.Trained=!0,this.prototype.callback(t.data.result);break;case"TrainingCallback":this.prototype.trainingCallback(t.data.result);break;default:console.log("Message from Worker",t.data)}}function s(){var t=new Worker(a);return t.addEventListener("message",e,!1),t}var n=!this.document,a=n?null:function(){var t=(Math.random()+""+ +new Date).substring(2);return document.write('<script id="wts'+t+'"></script>'),document.getElementById("wts"+t).previousSibling.src}();if(n){var r;t.addEventListener("message",i,!1)}var o=function(t){var i={Layers:[2,2,1],TrainingMethod:"BackPropagate",ActivationFunction:"ElliotSigmoid",ActivationFunctionDerivative:"Sigmoid",ErrorFunction:"MeanSquaredError",SingleThreaded:!1,AutomaticHiddenLayer:!0};if(!n&&window==this)return new o(t);var e=function(){for(var t=1;t<arguments.length;t++)for(var i in arguments[t])arguments[t].hasOwnProperty(i)&&(arguments[0][i]=arguments[t][i]);return arguments[0]};this.options=e({},i,t),this.SingleThreaded=this.options.SingleThreaded,this.Initialize(this.options.Layers)};o.prototype={rand_normal:function(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)},shuffle:function(t){for(var i,e,s=t.length;s;)e=Math.floor(Math.random()*s--),i=t[s],t[s]=t[e],t[e]=i;return t},randWeights:function(t){for(var i=new Array(t),e=0;t>e;e++)i[e]=this.rand_normal()/Math.sqrt(t);return i},randBias:function(t){for(var i=new Array(t),e=0;t>e;e++)i[e]=this.rand_normal();return i},zeros:function(t){for(var i=new Array(t),e=0;t>e;e++)i[e]=0;return i},ActivationFunctions:{Sigmoid:function(t){return 1/(1+Math.exp(-t))},HyperTan:function(t){return Math.tanh(t)},ElliotSigmoid:function(t){return.5*t/(1+Math.abs(t))+.5},ElliotSymmetrical:function(t){return t/(1+Math.abs(t))}},ActivationFunctionDerivatives:{Sigmoid:function(t,i){return(1-t)*t},HyperTan:function(t,i){return(1-t)*(1+t)},ElliotSigmoid:function(t,i){return 1/((1+Math.abs(i))*(1+Math.abs(i)))},ElliotSymmetrical:function(t,i){return.5/(1+Math.abs(i)*(1+Math.abs(i)))}},ErrorFunctions:{MeanSquaredError:{error:function(t,i){for(var e=0,s=0;s<t.length;s++){var n=i[s]-t[s];e+=n*n}return e/t.length},delta:function(t,i,e){return t-i}},Quadratic:{error:function(t,i){for(var e=0,s=0;s<t.length;s++){var n=i[s]-t[s];e+=n*n}return.5*e},delta:function(t,i,e){return(t-i)*e}},CrossEntropy:{error:function(t,i){for(var e=0,s=0;s<t.length;s++){var n=-t[s]*Math.log(i[s])-(1-t[s])*Math.log(1-i[s]);e+=isFinite(n)?n:0}return e/t.length},delta:function(t,i){return t-i}}},TrainingMethods:{BackPropagate:function(t,i,e){var a=i.epochs||2e4,r=i.shuffle||!1,o=i.errorThresh||.04,h=i.log||!1,u=i.logPeriod||500;i.learningRate=i.learningRate||.45,i.momentum=i.momentum||.3;var c=i.callbackPeriod||0,l=t.length;if(n||this.SingleThreaded){for(var g=9999,p=99999999,d=0;a>d&&g>o;d++){var v=0;r&&this.shuffle(t);for(var f=0;l>f;f++){var m=this.ComputeOutputs(t[f].input),y=t[f].output;v+=this.ErrorFunction.error(y,m,l),this.CalculateDeltas(y),this.UpdateWeights(i)}g=v,g>p&&(i.learningRate*=.05),p=g,h&&d%u==0&&console.log("epoch:",d,"training error:",g),c&&d%c==0&&(n?self.postMessage({command:"TrainingCallback",result:{epoch:d,error:g,learningRate:i.learningRate}}):i.callback({epoch:d,error:g}))}var M={error:g,epoch:d,iterations:l*d};return e(M),M}this.worker=s();var w=this;this.worker.prototype={_this:w,Result:!1,trainingCallback:i.callback,callback:e},i.callback=!0,this.worker.postMessage({command:"Train",options:this.options,weights:this.Weights,biases:this.Biases,data:t,trainingOptions:i})},Genetic:function(t,i,e){var r=i.popSize||30,h=i.epochs||12500,u=i.log||!1,c=i.logPeriod||500;this.options.learningRate=i.learningRate||.7;var l=i.callback,g=i.callbackPeriod||15,p=i.testFitnessFunction||this.testFitnessFunction,d=i.grabNBest||2,v=i.percentageToMate||.1,f=i.mateablePopulation||.25;if(this.options.crossOverRate=i.crossOverRate||.85,this.options.mutationRate=i.mutationRate||.5,n||this.SingleThreaded){for(var m=new Array(r),y=0;r>y;y++)m[y]=new o(this.options);for(var M,w={},b=function(t,i){return i.Fitness-t.Fitness},F=function(){var t=0;M.sort(b);for(var i=0,e=M.length;e>i;i++)t+=M[i].Fitness;w={totalFitness:t,Fittest:M[0].Fitness,Worst:M[e-1].Fitness,Average:t/M.length}},k=function(t){var i=t?v:f,e=Math.random()*i*r;return Math.floor(e)},W=this,T=0;h>T;)p(t,m,function(t){M=t,F();for(var e=[],s=0;d>s;s++)e[s]=m[M[s].index];for(;e.length<m.length;){var a,r,h=M[k(!0)].index,p=M[k()].index,v=m[h],f=m[p];h==p?(a=v,r=f):(a=new o(W.options),r=new o(W.options),W.Crossover(v,f,a,r)),Math.random()<W.options.mutationRate&&W.Mutate(a),Math.random()<W.options.mutationRate&&W.Mutate(r),e.push(a),e.push(r)}m=e,u&&T%c==0&&console.log("epoch:",T,w),l&&T%g==0&&(n?self.postMessage({command:"TrainingCallback",result:{epoch:T,generationInfo:w}}):i.callback({epoch:T,generationInfo:w}))}),T++;return W.Weights=m[M[0].index].Weights,W.Biases=m[M[0].index].Biases,e(w),w}this.worker=s();var L=this;this.worker.prototype={_this:L,Result:!1,trainingCallback:i.callback,callback:e},i.callback=!0,this.worker.postMessage({command:"Genetic",options:this.options,data:t,trainingOptions:i,path:a})}},CalculateDeltas:function(t){for(var i=this.outputLayer;i>=0;i--)for(var e=0;e<this.Layers[i];e++){var s=this.Outputs[i][e],n=this.Sums[i][e],a=0;if(i==this.outputLayer)a=s-t[e];else for(var r=this.Deltas[i+1],o=0;o<r.length;o++)a+=r[o]*this.Weights[i+1][o][e];this.Deltas[i][e]=a*this.ActivationFunctionDerivative(s,n)}},UpdateWeights:function(t){for(var i=1;i<=this.outputLayer;i++)for(var e=this.Outputs[i-1],s=0,n=this.Layers[i];n>s;s++){for(var a=this.Deltas[i][s],r=0,o=e.length;o>r;r++){var h=t.learningRate*a*e[r]+t.momentum*this.prevWeightsDelta[i][s][r];this.prevWeightsDelta[i][s][r]=h,this.Weights[i][s][r]-=h}this.Biases[i][s]-=t.learningRate*a}},testFitnessFunction:function(t,i,e){for(var s=i[0].ErrorFunction.error,n=new Array(i.length),a=0;a<i.length;a++){for(var r=0,o=0,h=t.length;h>o;o++)r-=s(t[o].output,i[a].ComputeOutputs(t[o].input));n[a]={index:a,Fitness:r}}e(n)},Crossover:function(t,i,e,s){if(Math.random()>this.options.crossOverRate)e=t,s=i;else for(var n=Math.floor(Math.random()*this.numWeights),a=Math.floor(Math.random()*this.numNeurons),r=0,o=0,h=1;h<t.Layers;h++)for(var u=0;u<t.Layers[h].length;u++){e.Biases[h][u]=o>=a?t.Biases[h][u]:i.Biases[h][u],s.Biases[h][u]=a<=o++?i.Weights[h][u]:t.Weights[h][u];for(var c=0,l=t.Weights[h][u].length;l>c;c++)e.Biases[h][u][c]=r>=n?t.Weights[h][u][c]:i.Weights[h][u][c],s.Biases[h][u][c]=n<=r++?i.Weights[h][u][c]:t.Weights[h][u][c]}},Mutate:function(t){for(var i=0;i<t.Layers;i++)for(var e=0;e<t.Layers[i];e++){Math.random()<this.options.mutationRate&&(t.Biases[i][e]+=tthis.options.learningRate*Math.random()-this.options.learningRate);for(var s=0;s<t.Weights[i][e];s++)Math.random()<this.options.mutationRate&&(t.Weights[i][e][s]+=Math.random()*this.options.learningRate-this.options.learningRate)}},Trained:!0,stop:function(){this.worker&&this.worker.postMessage({command:"Stop"})},Train:function(t,i,e){i=i||{},i.callback=i.callback||function(){},e=e||function(){},this.Trained=!1;var s=this.TrainingMethod(t,i,e);return s},ComputeOutputs:function(t){this.Outputs[0]=t;for(var i=1;i<=this.outputLayer;i++){for(var e=0,s=this.Layers[i];s>e;e++){for(var n=this.Weights[i][e],a=this.Biases[i][e],r=0,o=n.length;o>r;r++)a+=n[r]*t[r];this.Sums[i][e]=a,this.Outputs[i][e]=this.ActivationFunction(a)}var h=t=this.Outputs[i]}return h},Initialize:function(t){2==this.options.Layers.length&&this.options.AutomaticHiddenLayer&&Math.floor(2/3*this.options.Layers[0]+this.options.Layers[1]),n||this.SingleThreaded||(window.Worker?(this.cores=navigator.hardwareConcurrency,this.cores=this.cores||2):this.SingleThreaded=!0),"function"!=typeof this.options.ActivationFunction?this.ActivationFunction=this.ActivationFunctions[this.options.ActivationFunction]:(this.SingleThreaded=!0,this.ActivationFunction=this.options.ActivationFunction),this.options.ActivationFunctionDerivative=this.options.ActivationFunctionDerivative||this.options.ActivationFunction,"function"!=typeof this.options.ActivationFunctionDerivative?this.ActivationFunctionDerivative=this.ActivationFunctionDerivatives[this.options.ActivationFunctionDerivative]:(this.SingleThreaded=!0,this.ActivationFunctionDerivative=this.options.ActivationFunctionDerivative),"function"!=typeof this.options.TrainingMethod?this.TrainingMethod=this.TrainingMethods[this.options.TrainingMethod]:this.TrainingMethod=this.options.TrainingMethod,"function"!=typeof this.options.ErrorFunction?this.ErrorFunction=this.ErrorFunctions[this.options.ErrorFunction]:(this.SingleThreaded=!0,this.ErrorFunction=this.options.ErrorFunction);for(var i=1;i<=this.outputLayer;i++)this.numNeurons+=this.Layers[i],this.numWeights+=this.Layers[i]*this.Layers[i-1];this.Fitness=0,this.Layers=t,this.outputLayer=this.Layers.length-1,this.Sums=[],this.Biases=[],this.Weights=[],this.Outputs=[],this.prevWeightsDelta=[],this.prevBiasesDelta=[],this.Deltas=[];for(var i=0;i<=this.outputLayer;i++){var e=this.Layers[i];if(this.prevBiasesDelta[i]=this.zeros(e),this.Outputs[i]=this.zeros(e),this.Deltas[i]=this.zeros(e),this.Sums[i]=this.zeros(e),i>0){this.Biases[i]=this.randBias(e),this.Weights[i]=new Array(e),this.prevWeightsDelta[i]=new Array(e);for(var s=0;e>s;s++){var a=this.Layers[i-1];this.Weights[i][s]=this.randWeights(a),this.prevWeightsDelta[i][s]=this.zeros(a)}}}},saveNetwork:function(){var t={options:this.options,weights:this.Weights,biases:this.Biases},i="Network - "+new Date+".json",e=document.createElement("a");document.body.appendChild(e),e.style="display: none";var s=JSON.stringify(t),n=new Blob([s],{type:"octet/stream"}),a=window.URL.createObjectURL(n);e.href=a,e.download=i,e.click(),window.URL.revokeObjectURL(a)},loadNetwork:function(t){t=JSON.parse(t),this.options=t.options,this.Initialize(this.options.Layers),this.Biases=t.biases,this.Weights=t.weights}},n||(window.Intellect=o)}(this);